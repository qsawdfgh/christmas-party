<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ„ è–èª•äº¤æ›ç¦®ç‰©æ´¾å° ğŸğŸğŸ</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root { 
            --primary: #C41E3A; 
            --green: #165B33; 
            --gold: #D4AF37; 
            --glass: rgba(255, 255, 255, 0.85);
        }
        
        body {
            margin: 0; 
            font-family: 'Noto Sans TC', sans-serif;
            background: url('https://images.unsplash.com/photo-1543589077-47d81606c1bf?q=80&w=2069&auto=format&fit=crop') no-repeat center center fixed;
            background-size: cover;
            min-height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            position: relative; 
            overflow-x: hidden;
        }

        body::before { 
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(0, 0, 0, 0.4); z-index: 0; 
        }

        .container {
            position: relative; 
            background: var(--glass);
            backdrop-filter: blur(10px);
            padding: 2.5rem; 
            border-radius: 24px; 
            width: 85%; 
            max-width: 420px;
			box-sizing: border-box;
            text-align: center; 
            z-index: 10; 
            border: 2px solid rgba(255,255,255,0.6);
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
            animation: float 6s ease-in-out infinite;
        }

		/* æ‰‹æ©Ÿå°ˆç”¨å„ªåŒ– (è¢å¹•å°æ–¼ 480px æ™‚) */
		@media (max-width: 480px) {
    		.container {
        		/* æ‰‹æ©Ÿä¸Šè®“å¡ç‰‡ç¨å¾®å¯¬ä¸€é»ï¼Œè¦–è¦ºæ¯”è¼ƒå¹³è¡¡ */
        		width: 90%; 
        
        		/* æ‰‹æ©Ÿä¸Š padding æ”¹å°ä¸€é»ï¼Œçˆ­å–æ–‡å­—ç©ºé–“ */
        		padding: 1.5rem; 
    		}
		}

        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }

        h1 { 
            color: var(--primary); margin: 0 0 5px 0; font-weight: 900; 
            letter-spacing: 2px; text-shadow: 2px 2px 0 #fff;
        }
        
        .sub-title { color: var(--green); font-size: 0.9rem; font-weight: bold; margin-bottom: 20px; }

        input { 
            width: 88%; padding: 14px; margin: 8px 0; 
            border: 2px solid #fff; border-radius: 12px; font-size: 1rem; 
            background: rgba(255,255,255,0.9); transition: 0.3s;
        }
        input:focus { border-color: var(--green); outline: none; box-shadow: 0 0 10px rgba(22, 91, 51, 0.2); }

        button {
            background: linear-gradient(135deg, var(--primary), #a01830); 
            color: white; border: none; padding: 15px;
            border-radius: 50px; cursor: pointer; font-size: 1.1rem; width: 100%;
            margin-top: 15px; font-weight: bold; 
            box-shadow: 0 5px 15px rgba(196, 30, 58, 0.4);
            border: 2px solid white; transition: transform 0.1s;
        }
        button:active { transform: scale(0.96); }
        button.secondary { background: linear-gradient(135deg, var(--gold), #b8962e); color: #fff; box-shadow: 0 5px 15px rgba(212, 175, 55, 0.4); }
        button.danger { background: #666; font-size: 0.9rem; margin-top:30px; box-shadow: none; opacity: 0.8; }

        .list-area { 
            margin-top: 20px; text-align: left; max-height: 220px; overflow-y: auto; 
            border-top: 2px dashed #ccc; padding-top: 15px; 
        }
        .tag { 
            background: white; color: var(--green); 
            padding: 6px 14px; border-radius: 20px; display: inline-block; 
            margin: 4px; font-size: 0.9rem; font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .my-tag { background: var(--primary); color: white; }

        /* âœ¨ ç¦®ç‰©çµæœå¡ç‰‡ âœ¨ */
        .result-box { 
            background: white;
            background-image: radial-gradient(#f3e5f5 10%, transparent 11%), radial-gradient(#f3e5f5 10%, transparent 11%);
            background-size: 20px 20px;
            color: #333; 
            padding: 40px 20px; 
            border-radius: 16px; 
            margin-top: 25px; 
            border: 4px solid var(--gold); 
            position: relative;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: popIn 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        .result-box::after {
            content: 'TO:'; position: absolute; top: 15px; left: 15px; 
            font-size: 1rem; color: #999; font-weight: bold;
        }

        .bow {
            position: absolute; top: -30px; left: 50%; transform: translateX(-50%);
            font-size: 4rem; text-shadow: 0 5px 10px rgba(0,0,0,0.2);
        }

        /* èª¿æ•´èªªæ˜æ–‡å­—æ¨£å¼ï¼Œè®“å®ƒè·Ÿåå­—æœ‰å€éš” */
        #targetDesc { 
            font-size: 1.1rem; 
            color: #555; 
            font-weight: bold; 
            margin-top: 25px; 
            line-height: 1.6;
        }
        
        /* å¼·èª¿å½¢å®¹è© */
        .highlight-desc {
            color: var(--primary);
            font-size: 1.3rem;
            background: #fff0f0;
            padding: 2px 8px;
            border-radius: 5px;
            border-bottom: 2px solid var(--primary);
        }

        #targetName { 
            color: var(--primary); font-size: 3.2rem; margin: 5px 0 20px 0; 
            font-weight: 900; line-height: 1.1; letter-spacing: -1px;
            word-break: break-all;
        }

        .screenshot-hint {
            background: #f0f0f0; border-radius: 8px; padding: 8px;
            font-size: 0.8rem; color: #666; display: inline-block;
        }

        @keyframes popIn { 0% { transform: scale(0.5) rotate(-10deg); opacity: 0; } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }
        .hidden { display: none !important; }
        
        .lights { position: fixed; top: 0; width: 100%; display: flex; justify-content: center; gap: 30px; z-index: 5; pointer-events: none; }
        .light { width: 12px; height: 12px; border-radius: 50%; background: #ff3b3b; box-shadow: 0 0 15px #ff3b3b; animation: flash 1.5s infinite alternate; margin-top: -5px; position: relative;}
        .light::before { content: ''; position: absolute; top: -20px; left: 5px; width: 2px; height: 20px; background: #333; }
        .light:nth-child(even) { background: #ffd700; box-shadow: 0 0 15px #ffd700; animation-delay: 0.5s; }
        .light:nth-child(3n) { background: #26b85d; box-shadow: 0 0 15px #26b85d; animation-delay: 1s; }
        @keyframes flash { 0% { opacity: 0.3; } 100% { opacity: 1; transform: scale(1.2); } }
        .snowflake { position: fixed; top: -10px; color: #fff; text-shadow: 0 0 5px #fff; z-index: 2; pointer-events: none; animation: fall linear forwards; }
        @keyframes fall { to { transform: translateY(105vh) rotate(360deg); } }
    </style>
</head>
<body>

<div class="lights"><div class="light"></div><div class="light"></div><div class="light"></div><div class="light"></div><div class="light"></div><div class="light"></div><div class="light"></div></div>

<div class="container" id="app">
    <h1>è–èª•äº¤æ›ç¦®ç‰©</h1>
    <div class="sub-title">Christmas Gift Exchange 2025</div>
    <p id="statusText" style="font-size:0.9rem; color:#666;">ğŸ„ æ­£åœ¨é€£ç·šåŒ—æ¥µä¼ºæœå™¨...</p>

    <div id="step1">
        <div id="joinForm">
            <input type="text" id="myName" placeholder="ä½ çš„æš±ç¨± (ä¾‹: Tony)">
            <input type="text" id="myDesc" placeholder="è¨±é¡˜ç¦®ç‰©å½¢å®¹è© (ä¾‹: å¯¦ç”¨çš„)">
            <button onclick="joinGame()" id="joinBtn">ğŸ… é€²å…¥å°å±‹</button>
        </div>
        
        <div id="waitingArea" class="hidden">
            <h3 style="color:var(--gold); margin-bottom:5px;">ç­‰å¾…å…¶ä»–äººåˆ°é½Š...</h3>
            <p style="margin:0; color:#555;">ä½ çš„èº«ä»½ï¼š<span id="displayMyName" style="font-weight:bold; color:var(--primary);"></span></p>
        </div>

        <div class="list-area" id="listArea"></div>

        <button class="secondary hidden" id="adminStartBtn" onclick="hostStartGame()">
            ğŸ‘‘ å¤§å®¶éƒ½åˆ°äº†ï¼é–‹å§‹æŠ½ç
        </button>
    </div>

    <div id="step2" class="hidden">
        <h2 style="color:var(--primary); margin-top:0;">ğŸ‰ é…å°å®Œæˆï¼</h2>
        
        <div id="myResult" class="result-box hidden">
            <div class="bow">ğŸ</div>
            
            <div id="targetDesc"></div>
            
            <h1 id="targetName"></h1>
            <div class="screenshot-hint">ğŸ“¸ è«‹æˆªåœ–ä¿å­˜ï¼Œåˆ¥å‘Šè¨´å…¶ä»–äººå–”ï¼</div>
        </div>
        
        <div id="notInGameMsg" class="hidden">
            <p>ğŸ˜¢ å“å‘€ï¼ä½ ä¼¼ä¹æ²’æœ‰åœ¨é€™æ¬¡çš„åå–®ä¸­ã€‚<br>å¯èƒ½æ˜¯éŠæˆ²é–‹å§‹å¾Œä½ æ‰é€²ä¾†ã€‚</p>
        </div>
        
        <button class="danger" onclick="resetGame()">ğŸ”„ é‡æ–°é–‹å§‹ (Reset Game)</button>
    </div>
</div>

<script>
    // ==========================================
    // âš ï¸ è«‹åœ¨æ­¤è™•è²¼ä¸Šä½ çš„ Firebase Config âš ï¸
    // ==========================================
    const firebaseConfig = {
  		apiKey: "AIzaSyDsmR6x-yh6O7w7SPetrm6VdSHXN0mCeU0",
  		authDomain: "christmas-exchange-ed1d8.firebaseapp.com",
	  	databaseURL: "https://christmas-exchange-ed1d8-default-rtdb.firebaseio.com",
  		projectId: "christmas-exchange-ed1d8",
  		storageBucket: "christmas-exchange-ed1d8.firebasestorage.app",
  		messagingSenderId: "262833174996",
  		appId: "1:262833174996:web:627a2d84cc3eff11e7fe41"
	};

    if (!firebase.apps.length) {
        if(firebaseConfig.apiKey) firebase.initializeApp(firebaseConfig);
        else console.error("è«‹è¨˜å¾—å¡«å¯« Firebase Config!");
    }
    
    let db, participantsRef, assignmentsRef;
    if(firebase.apps.length) {
        db = firebase.database();
        participantsRef = db.ref('participants');
        assignmentsRef = db.ref('assignments');
    }

    const urlParams = new URLSearchParams(window.location.search);
    const isAdmin = urlParams.get('admin') === 'true';

    let myId = localStorage.getItem('christmas_uid');
    let myNameLocal = localStorage.getItem('christmas_name');
    let allUsers = [];

    if(participantsRef) {
        participantsRef.on('value', (snapshot) => {
            const listDiv = document.getElementById('listArea');
            listDiv.innerHTML = '';
            allUsers = [];
            
            const data = snapshot.val();
            let myIdExistsOnServer = false;

            if (data) {
                Object.keys(data).forEach(key => {
                    const u = data[key];
                    allUsers.push({ id: key, ...u });
                    if (key === myId) myIdExistsOnServer = true;

                    const span = document.createElement('span');
                    span.className = 'tag';
                    if(key === myId) span.classList.add('my-tag');
                    
                    if (key === myId) {
                        span.innerText = `â›„ ${u.name}`; 
                    } else {
                        span.innerText = `â„ï¸ ${u.name}`; 
                    }
                    listDiv.appendChild(span);
                });
            }
            
            if (myId && !myIdExistsOnServer) {
                localStorage.clear();
                location.reload();
                return;
            }

            const startBtn = document.getElementById('adminStartBtn');
            const statusText = document.getElementById('statusText');
            
            if (allUsers.length >= 2) {
                if (isAdmin) {
                    startBtn.classList.remove('hidden');
                    statusText.innerText = `ä½ æ˜¯ä¸»æŒäºº | ç›®å‰ ${allUsers.length} äºº`;
                } else {
                    startBtn.classList.add('hidden');
                    statusText.innerText = `ç›®å‰ ${allUsers.length} äººå·²å°±ä½ï¼Œç­‰å¾…é–‹å§‹...`;
                }
            } else {
                startBtn.classList.add('hidden');
                statusText.innerText = "ç­‰å¾…å¤§å®¶åŠ å…¥ä¸­... (è‡³å°‘éœ€è¦2äºº)";
            }
        });

        assignmentsRef.on('value', (snapshot) => {
            const assignments = snapshot.val();
            if (assignments) {
                showResult(assignments);
            } else {
                document.getElementById('step1').classList.remove('hidden');
                document.getElementById('step2').classList.add('hidden');
            }
        });
    }

    checkLoginState();

    function checkLoginState() {
        if (myId && myNameLocal) {
            document.getElementById('joinForm').classList.add('hidden');
            document.getElementById('waitingArea').classList.remove('hidden');
            document.getElementById('displayMyName').innerText = myNameLocal;
        }
    }

    function joinGame() {
        if(!db) return alert("è«‹å…ˆåœ¨ç¨‹å¼ç¢¼ä¸­å¡«å…¥ Firebase Configï¼");
        const name = document.getElementById('myName').value.trim();
        const desc = document.getElementById('myDesc').value.trim();
        if (!name || !desc) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡è¨Šï¼");
        if (allUsers.some(u => u.name === name)) return alert("é€™å€‹åå­—æœ‰äººç”¨éäº†ï¼Œæ›ä¸€å€‹å§ï¼");

        const newRef = participantsRef.push();
        myId = newRef.key;
        myNameLocal = name;

        newRef.set({ name, desc }).then(() => {
            localStorage.setItem('christmas_uid', myId);
            localStorage.setItem('christmas_name', name);
            checkLoginState();
        }).catch(err => alert("é€£ç·šéŒ¯èª¤: " + err.message));
    }

    function hostStartGame() {
        if (!isAdmin) return;
        if (!confirm("ç¢ºå®šæ‰€æœ‰äººéƒ½åŠ å…¥äº†å—ï¼Ÿè¦é–‹å§‹æŠ½çå›‰ï¼")) return;

        let givers = [...allUsers];
        let receivers = [...allUsers];
        let isValid = false;

        let attempts = 0;
        while (!isValid && attempts < 1000) {
            receivers.sort(() => Math.random() - 0.5);
            isValid = !givers.some((u, i) => u.id === receivers[i].id);
            attempts++;
        }

        if(!isValid) return alert("é…å°å¤±æ•—(äººæ•¸å¤ªå°‘æˆ–é‹æ°£ä¸å¥½)ï¼Œè«‹é‡è©¦ä¸€æ¬¡ï¼");

        let resultMap = {};
        givers.forEach((giver, i) => {
            resultMap[giver.id] = receivers[i];
        });

        assignmentsRef.set(resultMap);
    }

    // ==========================================
    // â¬‡ï¸ ä¿®æ”¹å¾Œçš„çµæœé¡¯ç¤ºé‚è¼¯ (å«å…©æ®µå¼æ–‡å­—) â¬‡ï¸
    // ==========================================
    function showResult(assignments) {
        document.getElementById('step1').classList.add('hidden');
        document.getElementById('step2').classList.remove('hidden');
        document.getElementById('statusText').innerText = "ğŸ æŠ½çå®Œæˆï¼å¿«çœ‹çœ‹ä½ æŠ½åˆ°èª°";

        if (myId && assignments[myId]) {
            const target = assignments[myId];
            document.getElementById('myResult').classList.remove('hidden');
            document.getElementById('notInGameMsg').classList.add('hidden');

            // 1. ä¿®æ”¹ä¸Šæ–¹å°æ¨™é¡Œ
            document.getElementById('targetDesc').innerText = "ä½ è¦é€çš„å°è±¡æ˜¯";

            // 2. ä¿®æ”¹ä¸­é–“å¤§åå­—
            const nameEl = document.getElementById('targetName');
            nameEl.innerText = target.name;

            // 3. è™•ç†ä¸‹æ–¹ã€ŒæœŸå¾…ç¦®ç‰©ã€çš„æ–‡å­—
            // æª¢æŸ¥æ˜¯å¦å·²ç¶“å»ºç«‹é giftInfo å€å¡Šï¼Œå¦‚æœæ²’æœ‰å°±å»ºç«‹ä¸€å€‹æ–°çš„æ’åœ¨åå­—ä¸‹é¢
            let giftInfo = document.getElementById('giftInfo');
            
            if (!giftInfo) {
                giftInfo = document.createElement('div');
                giftInfo.id = 'giftInfo';
                
                // è¨­å®šæ¨£å¼ï¼Œè®“å®ƒè·Ÿä¸Šæ–¹çš„èªªæ˜æ–‡å­—é¢¨æ ¼ä¸€è‡´
                giftInfo.style.marginTop = '15px';       // èˆ‡åå­—çš„è·é›¢
                giftInfo.style.fontSize = '1.1rem';      // å­—é«”å¤§å°
                giftInfo.style.color = '#555';           // é¡è‰²
                giftInfo.style.fontWeight = 'bold';      // ç²—é«”
                giftInfo.style.lineHeight = '1.6';       // è¡Œé«˜
                
                // å°‡é€™å€‹æ–°å€å¡Šæ’å…¥åˆ°åå­— (nameEl) çš„å¾Œé¢
                nameEl.after(giftInfo);
            }

            // è¨­å®šå…§å®¹æ–‡å­—ï¼Œå½¢å®¹è©ä¸€æ¨£ä¿ç•™æ¼‚äº®çš„ç²‰ç´…åº•è‰²
            giftInfo.innerHTML = `ä»–æœŸå¾…çš„ç¦®ç‰©æ˜¯ <span class="highlight-desc">ã€Œ${target.desc}ã€</span>`;

        } else {
            document.getElementById('myResult').classList.add('hidden');
            document.getElementById('notInGameMsg').classList.remove('hidden');
        }

        const resetBtn = document.querySelector('button.danger');
        if (isAdmin) {
            resetBtn.classList.remove('hidden');
        } else {
            resetBtn.classList.add('hidden');
        }
    }

    function resetGame() {
        if (!isAdmin) return;
        if(confirm("è­¦å‘Šï¼šé€™æœƒæ¸…é™¤æ‰€æœ‰çµæœä¸¦å¼·åˆ¶æ‰€æœ‰äººç™»å‡ºï¼ç¢ºå®šè¦é–‹å§‹æ–°çš„ä¸€å±€ï¼Ÿ")) {
            participantsRef.remove();
            assignmentsRef.remove();
        }
    }

    setInterval(()=>{
        const s = document.createElement('div');
        s.className = 'snowflake';
        s.innerHTML = ['â„', 'â…', 'â†'][Math.floor(Math.random()*3)];
        s.style.left = Math.random() * 100 + 'vw';
        s.style.animationDuration = Math.random() * 3 + 5 + 's';
        s.style.opacity = Math.random() * 0.5 + 0.3;
        s.style.fontSize = Math.random() * 15 + 10 + 'px';
        document.body.appendChild(s);
        setTimeout(() => s.remove(), 8000);
    }, 200);
</script>
</body>
</html>
